---
# tasks file for kibana_setup
# - name: setup
#   setup:
#   tags: kibana_setup, env_deps

- name: Install env deps
  include_tasks: 
    file: tasks/env_wide_deps.yml  
  tags: kibana_setup, env_deps

- name: Install kibana 
  apt:
    name:
      - kibana
      - filebeat
    state: present
    update_cache: true
    cache_valid_time: 21600
  tags: kibana_setup

- name: Get elasticsearch enrollment token
  shell: "/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana"
  register: kibana_token
  when: new_kibana_node == true 

- name: enroll in elasticsearch cluster
  shell: "/usr/share/kibana/bin/kibana-setup --enrollment-token {{kibana_token.stdout}}"
  register: enrollment_result
  when: new_kibana_node == true 
  tags: kibana_setup

- name: enrollment result
  debug:
    msg: "{{enrollment_result.stdout}}"
  tags: kibana_setup
  when: new_kibana_node == true

- name: Start kibana
  service:
    name: kibana
    state: started
    enabled: true
